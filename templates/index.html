{% extends "bootstrap/base.html" %}

{% block title %}クラウドワークス案件一覧{% endblock %}

{% block styles %}
{{super()}}
<style>
    .table-container {
        margin-top: 2rem;
        margin-bottom: 2rem;
    }
    .check-column {
        width: 50px;
    }
    .title-column {
        min-width: 300px;
    }
    .budget-column {
        width: 150px;
    }
    .client-column {
        width: 150px;
    }
    .date-column {
        width: 120px;
    }
    .reason-column {
        width: 200px;
    }
    .toggle-details {
        padding: 0.25rem 0.5rem;
        margin-left: 0.5rem;
        color: #007bff;
        background: none;
        border: 1px solid #007bff;
        border-radius: 4px;
        cursor: pointer;
    }
    .toggle-details:hover {
        background-color: #007bff;
        color: #fff;
    }
    .modal-body {
        white-space: pre-wrap;
        max-height: 70vh;
        overflow-y: auto;
    }
    .modal-title {
        font-size: 1.2rem;
        font-weight: bold;
        margin-right: 2rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container table-container">
    <h2 class="mb-4">クラウドワークス案件一覧</h2>
    <div class="table-responsive">
        <table class="table table-striped table-hover">
            <thead class="thead-dark">
                <tr>
                    <th class="check-column">確認</th>
                    <th class="title-column">タイトル</th>
                    <th class="budget-column">予算</th>
                    <th class="client-column">クライアント</th>
                    <th class="date-column">投稿日</th>
                    <th class="reason-column">選定理由</th>
                </tr>
            </thead>
            <tbody>
                {% for job in jobs %}
                <tr>
                    <td class="check-column">
                        <div class="form-check">
                            <input type="checkbox" 
                                   class="form-check-input job-check" 
                                   data-url="{{ job.url }}"
                                   {% if job.url in checks and checks[job.url].checked %}checked{% endif %}>
                        </div>
                    </td>
                    <td class="title-column">
                        <a href="{{ job.url }}" target="_blank">{{ job.title }}</a>
                        <button class="toggle-details" 
                                data-toggle="modal" 
                                data-target="#detailsModal" 
                                data-title="{{ job.title }}"
                                data-description="{{ job.detail_description }}">
                            詳細を表示
                        </button>
                    </td>
                    <td class="budget-column">{{ job.budget }}</td>
                    <td class="client-column">{{ job.client }}</td>
                    <td class="date-column">{{ job.posted_date }}</td>
                    <td class="reason-column">{{ job.gpt_reason if job.gpt_reason else '' }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="detailsModal" tabindex="-1" role="dialog" aria-labelledby="detailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="detailsModalLabel"></h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body"></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">閉じる</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{super()}}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const checkboxes = document.querySelectorAll('.job-check');
    const detailsModal = document.getElementById('detailsModal');
    
    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const url = this.dataset.url;
            const checked = this.checked;
            
            fetch('/update_check', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    url: url,
                    checked: checked
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status !== 'success') {
                    console.error('チェック状態の更新に失敗しました');
                    this.checked = !checked;  // 失敗した場合は元の状態に戻す
                }
            })
            .catch(error => {
                console.error('エラー:', error);
                this.checked = !checked;  // エラーの場合は元の状態に戻す
            });
        });
    });

    // モーダルの設定
    $('#detailsModal').on('show.bs.modal', function (event) {
        const button = $(event.relatedTarget);
        const title = button.data('title');
        const description = button.data('description');
        
        const modal = $(this);
        modal.find('.modal-title').text(title);
        modal.find('.modal-body').html(description);
    });
});
</script>
{% endblock %} 