{% extends "bootstrap/base.html" %}

{% block title %}クラウドワークス案件一覧{% endblock %}

{% block styles %}
{{super()}}
<style>
    .wrapper {
        display: flex;
        width: 100%;
    }
    
    #sidebar {
        min-width: 250px;
        max-width: 250px;
        min-height: 100vh;
        background: #343a40;
        color: #fff;
        transition: all 0.3s;
    }
    
    #sidebar .sidebar-header {
        padding: 20px;
        background: #2c3136;
    }
    
    #sidebar ul.components {
        padding: 20px 0;
        border-bottom: 1px solid #47748b;
    }
    
    #sidebar ul li a {
        padding: 10px;
        font-size: 1.1em;
        display: block;
        color: #fff;
        text-decoration: none;
    }
    
    #sidebar ul li a:hover {
        background: #2c3136;
    }
    
    #sidebar .btn-fetch {
        margin: 15px 20px;
        width: calc(100% - 40px);
    }
    
    #content {
        width: 100%;
        padding: 20px;
        min-height: 100vh;
        transition: all 0.3s;
    }
    
    .table-container {
        margin-top: 2rem;
        margin-bottom: 2rem;
    }
    .check-column {
        width: 50px;
    }
    .title-column {
        min-width: 300px;
    }
    .budget-column {
        width: 150px;
    }
    .client-column {
        width: 150px;
    }
    .date-column {
        width: 120px;
    }
    .reason-column {
        width: 200px;
    }
    .toggle-details {
        padding: 0.25rem 0.5rem;
        margin-left: 0.5rem;
        color: #007bff;
        background: none;
        border: 1px solid #007bff;
        border-radius: 4px;
        cursor: pointer;
    }
    .toggle-details:hover {
        background-color: #007bff;
        color: #fff;
    }
    .modal-body {
        white-space: pre-wrap;
        max-height: 70vh;
        overflow-y: auto;
    }
    .modal-title {
        font-size: 1.2rem;
        font-weight: bold;
        margin-right: 2rem;
    }
    #sidebar .form-group {
        padding: 10px 20px;
        color: #fff;
    }

    #sidebar .form-group label {
        color: #fff;
        margin-bottom: 5px;
    }

    #sidebar .form-control {
        background-color: #2c3136;
        border: 1px solid #47748b;
        color: #fff;
    }

    #sidebar .form-control:focus {
        background-color: #2c3136;
        color: #fff;
        border-color: #007bff;
    }

    #sidebar input[type="number"] {
        width: 100%;
    }

    #sidebar .model-container {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 10px;
    }

    #sidebar .model-label-container {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 5px;
    }

    #sidebar .api-key-btn {
        color: #adb5bd;
        background: none;
        border: none;
        padding: 0 5px;
        font-size: 0.9em;
        cursor: pointer;
        text-decoration: none;
    }

    #sidebar .api-key-btn:hover {
        color: #ced4da;
    }

    .api-key-modal .modal-content {
        background-color: #343a40;
        color: #fff;
    }

    .api-key-modal .modal-header {
        border-bottom: 1px solid #47748b;
    }

    .api-key-modal .modal-footer {
        border-top: 1px solid #47748b;
    }

    .api-key-modal .form-control {
        background-color: #2c3136;
        border: 1px solid #47748b;
        color: #fff;
    }

    .api-key-modal .form-control:focus {
        background-color: #2c3136;
        color: #fff;
        border-color: #007bff;
    }

    .filter-settings {
        background-color: #f8f9fa;
        padding: 20px;
        border-radius: 5px;
        margin-bottom: 20px;
    }

    .filter-settings textarea {
        width: 100%;
        min-height: 200px;
        resize: vertical;
    }

    #content .view-container {
        display: none;
    }

    #content .view-container.active {
        display: block;
    }

    .btn-disabled {
        background-color: #6c757d;
        border-color: #6c757d;
        cursor: not-allowed;
        opacity: 0.65;
    }

    .btn-disabled:hover {
        background-color: #6c757d;
        border-color: #6c757d;
    }

    .detail-column {
        width: 100px;
        text-align: center;
    }
    
    .btn-outline-info {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
    }
    
    .job-details th {
        background-color: #f8f9fa;
    }
    
    .modal-description {
        white-space: pre-wrap;
    }

    .progress-wrapper {
        position: relative;
        width: 100%;
    }
    
    .progress-percentage {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: #1a237e;
        font-weight: bold;
        text-shadow: 0 0 3px rgba(255, 255, 255, 0.8);
        font-size: 1.2rem;
        z-index: 1;
        background: rgba(255, 255, 255, 0.7);
        padding: 0 8px;
        border-radius: 3px;
    }
    
    .progress-container progress {
        width: 100%;
        height: 32px;
        border-radius: 4px;
    }
    
    .progress-container progress::-webkit-progress-bar {
        background-color: #f5f5f5;
        border-radius: 4px;
    }
    
    .progress-container progress::-webkit-progress-value {
        background-color: #007bff;
        border-radius: 4px;
        transition: width 0.3s ease;
    }
    
    .progress-container progress::-moz-progress-bar {
        background-color: #007bff;
        border-radius: 4px;
        transition: width 0.3s ease;
    }
</style>
{% endblock %}

{% block content %}
<div class="wrapper">
    <!-- Sidebar -->
    <nav id="sidebar">
        <div class="sidebar-header">
            <h3>案件naviCHO</h3>
        </div>
        
        <button class="btn btn-primary btn-fetch">新規情報の取得</button>
        
        <!-- プログレスバーを追加（最初から領域を確保） -->
        <div class="progress-container" style="padding: 10px 20px; visibility: hidden;" aria-busy="true" aria-describedby="progress-status">
            <div class="progress-wrapper" style="position: relative;">
                <progress id="progress-bar" class="progress" value="0" max="100" aria-label="データ取得中..."></progress>
                <span id="progress-percentage" class="progress-percentage">0/0</span>
            </div>
            <small id="progress-status" class="progress-status text-light" style="display: block; text-align: center; margin-top: 5px;">処理中...</small>
        </div>

        <ul class="list-unstyled components">
            <li>
                <a href="#" class="service-link active" data-service="crowdworks">クラウドワークス ▶︎</a>
            </li>
            <li>
                <a href="#" class="service-link" data-service="coconala">ココナラ ▶︎</a>
            </li>
        </ul>
        
        <div class="sidebar-header">
            <h3>設定</h3>
        </div>
        
        <div class="form-group">
            <div class="model-label-container">
                <label for="model-select">モデル</label>
                <button type="button" class="api-key-btn" data-toggle="modal" data-target="#apiKeyModal">
                    API Key
                </button>
            </div>
            <select class="form-control" id="model-select">
                <option value="gpt-4o-mini" {% if settings.model == 'gpt-4o-mini' %}selected{% endif %}>GPT-4o-mini</option>
                <option value="gpt-4o" {% if settings.model == 'gpt-4o' %}selected{% endif %}>GPT-4o</option>
                <option value="o1-mini" {% if settings.model == 'o1-mini' %}selected{% endif %}>o1-mini</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="max-items">MAX件数</label>
            <input type="number" class="form-control" id="max-items" min="1" max="100" value="{{ settings.max_items }}">
        </div>
        
        <ul class="list-unstyled components">
            <li>
                <a href="#" class="filter-settings-link">フィルター設定</a>
            </li>
        </ul>
    </nav>

    <!-- Page Content -->
    <div id="content">
        <div class="container-fluid">
            <!-- ジョブ一覧ビュー -->
            <div class="view-container active" id="jobs-view">
                <h2 class="mb-4">クラウドワークス案件一覧</h2>
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="thead-dark">
                            <tr>
                                <th class="check-column">応募</th>
                                <th class="title-column">タイトル</th>
                                <th class="detail-column">詳細</th>
                                <th class="budget-column">予算</th>
                                <th class="client-column">クライアント</th>
                                <th class="date-column">投稿日</th>
                                <th class="reason-column">選定理由</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for job in jobs %}
                            <tr>
                                <td class="check-column">
                                    <div class="form-check">
                                        <input type="checkbox" 
                                               class="form-check-input job-check" 
                                               data-url="{{ job.url }}"
                                               {% if job.url in checks and checks[job.url].checked %}checked{% endif %}>
                                    </div>
                                </td>
                                <td class="title-column">
                                    <a href="{{ job.url }}" target="_blank">{{ job.title }}</a>
                                </td>
                                <td class="detail-column">
                                    <button class="btn btn-sm btn-info" 
                                            data-toggle="modal" 
                                            data-target="#detailsModal"
                                            data-title="{{ job.title }}"
                                            data-budget="{{ job.budget }}"
                                            data-client="{{ job.client }}"
                                            data-posted-date="{{ job.posted_date }}"
                                            data-description="{{ job.detail_description }}">
                                        詳細を表示
                                    </button>
                                </td>
                                <td class="budget-column">{{ job.budget }}</td>
                                <td class="client-column">{{ job.client }}</td>
                                <td class="date-column">{{ job.posted_date }}</td>
                                <td class="reason-column">{{ job.gpt_reason if job.gpt_reason else '' }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- フィルター設定ビュー -->
            <div class="view-container" id="filter-view">
                <h2 class="mb-4">フィルター設定</h2>
                <div class="filter-settings">
                    <div class="form-group">
                        <label for="filter-prompt">フィルター条件</label>
                        <p class="text-muted">案件をフィルタリングするための条件を入力してください。</p>
                        <textarea class="form-control" id="filter-prompt" 
                                placeholder="例: 予算が10,000円以上で、Pythonに関連する案件のみ選択">{{ settings.filter_prompt }}</textarea>
                    </div>
                    <button class="btn btn-secondary btn-disabled" id="save-filter" disabled>保存</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="detailsModal" tabindex="-1" role="dialog" aria-labelledby="detailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="detailsModalLabel"></h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="job-details">
                    <table class="table table-bordered">
                        <tr>
                            <th style="width: 120px;">予算</th>
                            <td class="modal-budget"></td>
                        </tr>
                        <tr>
                            <th>クライアント</th>
                            <td class="modal-client"></td>
                        </tr>
                        <tr>
                            <th>投稿日</th>
                            <td class="modal-posted-date"></td>
                        </tr>
                        <tr>
                            <th>詳細説明</th>
                            <td class="modal-description"></td>
                        </tr>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">閉じる</button>
            </div>
        </div>
    </div>
</div>

<!-- API Key Modal -->
<div class="modal fade api-key-modal" id="apiKeyModal" tabindex="-1" role="dialog" aria-labelledby="apiKeyModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="apiKeyModalLabel">API Key設定</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="api-key-input">API Key</label>
                    <input type="password" class="form-control" id="api-key-input" placeholder="API Keyを入力してください" value="{{ settings.api_key if settings.api_key else '' }}">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">キャンセル</button>
                <button type="button" class="btn btn-primary" id="save-api-key">保存</button>
            </div>
        </div>
    </div>
</div>

<!-- Service Auth Modal -->
<div class="modal fade api-key-modal" id="serviceAuthModal" tabindex="-1" role="dialog" aria-labelledby="serviceAuthModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="serviceAuthModalLabel">認証設定</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="service-email">メールアドレス</label>
                    <input type="email" class="form-control" id="service-email" placeholder="メールアドレスを入力">
                </div>
                <div class="form-group">
                    <label for="service-password">パスワード</label>
                    <input type="password" class="form-control" id="service-password" placeholder="パスワードを入力">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">キャンセル</button>
                <button type="button" class="btn btn-primary" id="save-service-auth">保存</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{super()}}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const checkboxes = document.querySelectorAll('.job-check');
    const detailsModal = document.getElementById('detailsModal');
    
    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const url = this.dataset.url;
            const checked = this.checked;
            
            fetch('/update_check', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    url: url,
                    checked: checked
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status !== 'success') {
                    console.error('チェック状態の更新に失敗しました');
                    this.checked = !checked;  // 失敗した場合は元の状態に戻す
                }
            })
            .catch(error => {
                console.error('エラー:', error);
                this.checked = !checked;  // エラーの場合は元の状態に戻す
            });
        });
    });

    // モーダルの設定
    $('#detailsModal').on('show.bs.modal', function (event) {
        const button = $(event.relatedTarget);
        const title = button.data('title');
        const budget = button.data('budget');
        const client = button.data('client');
        const postedDate = button.data('posted-date');
        const description = button.data('description');
        
        const modal = $(this);
        modal.find('.modal-title').text(title);
        modal.find('.modal-budget').text(budget);
        modal.find('.modal-client').text(client);
        modal.find('.modal-posted-date').text(postedDate);
        modal.find('.modal-description').html(description);
    });

    // 新規情報取得ボタンのイベントリスナー
    document.querySelector('.btn-fetch').addEventListener('click', async function() {
        try {
            const button = this;
            const progressContainer = document.querySelector('.progress-container');
            const progressBar = document.querySelector('#progress-bar');
            const progressStatus = document.querySelector('#progress-status');
            const progressPercentage = document.querySelector('#progress-percentage');
            const maxItems = parseInt(document.getElementById('max-items').value) || 50;
            
            button.disabled = true;
            button.textContent = '取得中...';
            progressContainer.style.visibility = 'visible';  // display: none から visibility: hidden に変更
            
            // プログレス更新の開始
            let progress = 0;
            const progressInterval = setInterval(() => {
                if (progress < 90) {  // 90%まで徐々に進める
                    progress += Math.random() * 15;
                    const currentProgress = Math.min(progress, 90);
                    // 2つの処理（クローリングとLLM）を1タスクとしてカウント
                    const processedItems = Math.floor((currentProgress / 100) * maxItems);
                    progressBar.value = currentProgress;
                    progressPercentage.textContent = `${processedItems}/${maxItems}`;
                }
            }, 1000);
            
            // 進捗状況の取得を開始
            const statusCheckInterval = setInterval(async () => {
                try {
                    const statusResponse = await fetch('/fetch_status');
                    const statusData = await statusResponse.json();
                    if (statusData.status === 'running') {
                        const message = statusData.message || '処理中...';
                        progressStatus.textContent = message;
                        progressBar.setAttribute('aria-label', message);
                        
                        // ログメッセージに基づいて進捗状況を更新
                        if (message.includes('GPTフィルタリング')) {
                            // フィルタリング中は現在のタスクの後半として扱う
                            const currentTaskProgress = Math.floor(progress / 100 * maxItems);
                            const additionalHalf = 0.5; // 現在のタスクの半分まで進める
                            progressPercentage.textContent = `${currentTaskProgress + additionalHalf}/${maxItems}`;
                        }
                    }
                } catch (error) {
                    console.error('Status check error:', error);
                }
            }, 1000);
            
            const response = await fetch('/fetch_new_data', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            
            const data = await response.json();
            
            // インターバルをクリア
            clearInterval(progressInterval);
            clearInterval(statusCheckInterval);
            
            if (data.status === 'success') {
                // 完了時は100%にする
                progressBar.value = 100;
                progressPercentage.textContent = `${maxItems}/${maxItems}`;
                const completeMessage = '完了！';
                progressStatus.textContent = completeMessage;
                progressBar.setAttribute('aria-label', completeMessage);
                setTimeout(() => {
                    progressContainer.style.visibility = 'hidden';  // display: none から visibility: hidden に変更
                    // 完了メッセージを表示
                    alert('新規データの取得が完了しました');
                    // 画面をリフレッシュ
                    window.location.reload();
                }, 500);
            } else {
                throw new Error(data.message);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('エラーが発生しました: ' + error.message);
        } finally {
            const button = document.querySelector('.btn-fetch');
            button.disabled = false;
            button.textContent = '新規情報の取得';
        }
    });

    // テーブルの内容を更新する関数
    function updateJobsTable(jobs) {
        const tbody = document.querySelector('table tbody');
        tbody.innerHTML = '';
        
        jobs.forEach(job => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="check-column">
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input job-check" data-url="${job.url}" 
                            ${checks[job.url]?.checked ? 'checked' : ''}>
                    </div>
                </td>
                <td class="title-column">
                    <a href="${job.url}" target="_blank">${job.title}</a>
                </td>
                <td class="detail-column">
                    <button class="btn btn-sm btn-info" 
                            data-toggle="modal" 
                            data-target="#detailsModal"
                            data-title="${job.title}"
                            data-budget="${job.budget}"
                            data-client="${job.client}"
                            data-posted-date="${new Date(job.posted_date).toLocaleDateString()}"
                            data-description="${job.detail_description || '詳細情報なし'}">
                        詳細を表示
                    </button>
                </td>
                <td class="budget-column">${job.budget}</td>
                <td class="client-column">${job.client}</td>
                <td class="date-column">${new Date(job.posted_date).toLocaleDateString()}</td>
                <td class="reason-column">${job.gpt_reason || ''}</td>
            `;
            tbody.appendChild(tr);
        });
    }

    // 設定の変更を監視
    document.getElementById('model-select').addEventListener('change', function() {
        const selectedModel = this.value;
        updateSettings({ model: selectedModel });
    });

    document.getElementById('max-items').addEventListener('change', function() {
        const maxItems = parseInt(this.value);
        if (maxItems >= 1 && maxItems <= 100) {
            updateSettings({ max_items: maxItems });
        }
    });

    // API Key保存処理
    document.getElementById('save-api-key').addEventListener('click', function() {
        const apiKey = document.getElementById('api-key-input').value;
        updateSettings({ api_key: apiKey });
        $('#apiKeyModal').modal('hide');
    });

    // フィルター設定リンクのクリックイベント
    document.querySelector('.filter-settings-link').addEventListener('click', function(e) {
        e.preventDefault();
        
        // ビューを切り替え
        const views = document.querySelectorAll('.view-container');
        views.forEach(view => view.classList.remove('active'));
        document.getElementById('filter-view').classList.add('active');
        
        // フィルター設定の初期状態を設定
        const filterPrompt = document.getElementById('filter-prompt');
        originalFilterPrompt = filterPrompt.value;
        const saveFilterBtn = document.getElementById('save-filter');
        saveFilterBtn.classList.remove('btn-primary');
        saveFilterBtn.classList.add('btn-secondary', 'btn-disabled');
        saveFilterBtn.disabled = true;
    });

    // サービスリンクのクリック処理
    const serviceLinks = document.querySelectorAll('.service-link');
    let currentService = '';
    
    serviceLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const service = this.dataset.service;
            currentService = service;
            
            // アクティブなリンクを更新
            serviceLinks.forEach(l => l.classList.remove('active'));
            this.classList.add('active');
            
            // 認証情報をチェック
            fetch('/check_auth', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ service: service })
            })
            .then(response => response.json())
            .then(data => {
                if (!data.authenticated) {
                    // 認証情報がない場合はモーダルを表示
                    const modal = $('#serviceAuthModal');
                    modal.find('.modal-title').text(`${service === 'crowdworks' ? 'CrowdWorks' : 'ココナラ'}の認証設定`);
                    modal.find('#service-email').val('');
                    modal.find('#service-password').val('');
                    modal.modal('show');
                }
                
                // ビューをジョブ一覧に切り替え
                const views = document.querySelectorAll('.view-container');
                views.forEach(view => view.classList.remove('active'));
                document.getElementById('jobs-view').classList.add('active');
            });
        });
    });

    // サービス認証情報の保存
    document.getElementById('save-service-auth').addEventListener('click', function() {
        const email = document.getElementById('service-email').value;
        const password = document.getElementById('service-password').value;
        
        const settings = {
            [`${currentService}_email`]: email,
            [`${currentService}_password`]: password
        };
        
        updateSettings(settings);
        $('#serviceAuthModal').modal('hide');
        
        // ビューを切り替え
        const views = document.querySelectorAll('.view-container');
        views.forEach(view => view.classList.remove('active'));
        document.getElementById('jobs-view').classList.add('active');
    });

    // フィルター設定の変更監視
    let originalFilterPrompt = document.getElementById('filter-prompt').value;
    const saveFilterBtn = document.getElementById('save-filter');
    
    document.getElementById('filter-prompt').addEventListener('input', function() {
        const currentValue = this.value;
        const hasChanged = currentValue !== originalFilterPrompt;
        
        if (hasChanged) {
            saveFilterBtn.classList.remove('btn-secondary', 'btn-disabled');
            saveFilterBtn.classList.add('btn-primary');
            saveFilterBtn.disabled = false;
        } else {
            saveFilterBtn.classList.remove('btn-primary');
            saveFilterBtn.classList.add('btn-secondary', 'btn-disabled');
            saveFilterBtn.disabled = true;
        }
    });

    // フィルター設定の保存
    document.getElementById('save-filter').addEventListener('click', function() {
        const filterPrompt = document.getElementById('filter-prompt').value;
        updateSettings({ filter_prompt: filterPrompt });
        
        // 保存後に状態をリセット
        originalFilterPrompt = filterPrompt;
        this.classList.remove('btn-primary');
        this.classList.add('btn-secondary', 'btn-disabled');
        this.disabled = true;
        
        alert('フィルター設定を保存しました');
    });

    // 設定を更新する関数
    function updateSettings(settings) {
        fetch('/update_settings', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(settings)
        })
        .then(response => response.json())
        .then(data => {
            if (data.status !== 'success') {
                console.error('設定の更新に失敗しました:', data.message);
            }
        })
        .catch(error => {
            console.error('エラー:', error);
        });
    }
});
</script>
{% endblock %} 