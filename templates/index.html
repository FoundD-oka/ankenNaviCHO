{% extends "bootstrap/base.html" %}

{% block title %}クラウドワークス案件一覧{% endblock %}

{% block styles %}
{{super()}}
<style>
    .wrapper {
        display: flex;
        width: 100%;
    }
    
    #sidebar {
        min-width: 250px;
        max-width: 250px;
        min-height: 100vh;
        background: #343a40;
        color: #fff;
        transition: all 0.3s;
    }
    
    #sidebar .sidebar-header {
        padding: 20px;
        background: #2c3136;
    }
    
    #sidebar ul.components {
        padding: 20px 0;
        border-bottom: 1px solid #47748b;
    }
    
    #sidebar ul li a {
        padding: 10px;
        font-size: 1.1em;
        display: block;
        color: #fff;
        text-decoration: none;
    }
    
    #sidebar ul li a:hover {
        background: #2c3136;
    }
    
    #sidebar .btn-fetch {
        margin: 15px 20px;
        width: calc(100% - 40px);
    }
    
    #content {
        width: 100%;
        padding: 20px;
        min-height: 100vh;
        transition: all 0.3s;
    }
    
    .user-info {
        padding: 10px 20px;
        display: flex;
        justify-content: center;
        align-items: center;
        background: #2c3136;
        position: relative;
    }
    
    .user-avatar-container {
        cursor: pointer;
    }

    .user-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        transition: transform 0.2s;
    }

    .user-avatar:hover {
        transform: scale(1.1);
    }

    .logout-toast {
        position: absolute;
        top: 100%;
        background: #fff;
        color: #333;
        padding: 8px 16px;
        border-radius: 4px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        z-index: 1000;
        cursor: pointer;
        display: none;
        animation: fadeIn 0.2s ease-in-out;
    }

    .logout-toast:hover {
        background: #f8f9fa;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .table-container {
        margin-top: 2rem;
        margin-bottom: 2rem;
    }
    .check-column {
        width: 50px;
    }
    .title-column {
        min-width: 300px;
    }
    .budget-column {
        width: 150px;
    }
    .client-column {
        width: 150px;
    }
    .date-column {
        width: 120px;
    }
    .reason-column {
        width: 200px;
    }
    .toggle-details {
        padding: 0.25rem 0.5rem;
        margin-left: 0.5rem;
        color: #007bff;
        background: none;
        border: 1px solid #007bff;
        border-radius: 4px;
        cursor: pointer;
    }
    .toggle-details:hover {
        background-color: #007bff;
        color: #fff;
    }
    .modal-body {
        white-space: pre-wrap;
        max-height: 70vh;
        overflow-y: auto;
    }
    .modal-title {
        font-size: 1.2rem;
        font-weight: bold;
        margin-right: 2rem;
    }
    #sidebar .form-group {
        padding: 10px 20px;
        color: #fff;
    }

    #sidebar .form-group label {
        color: #fff;
        margin-bottom: 5px;
    }

    #sidebar .form-control {
        background-color: #2c3136;
        border: 1px solid #47748b;
        color: #fff;
    }

    #sidebar .form-control:focus {
        background-color: #2c3136;
        color: #fff;
        border-color: #007bff;
    }

    #sidebar input[type="number"] {
        width: 100%;
    }

    #sidebar .model-container {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 10px;
    }

    #sidebar .model-label-container {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 5px;
    }

    #sidebar .api-key-btn {
        color: #adb5bd;
        background: none;
        border: none;
        padding: 0 5px;
        font-size: 0.9em;
        cursor: pointer;
        text-decoration: none;
    }

    #sidebar .api-key-btn:hover {
        color: #ced4da;
    }

    .api-key-modal .modal-content {
        background-color: #343a40;
        color: #fff;
    }

    .api-key-modal .modal-header {
        border-bottom: 1px solid #47748b;
    }

    .api-key-modal .modal-footer {
        border-top: 1px solid #47748b;
    }

    .api-key-modal .form-control {
        background-color: #2c3136;
        border: 1px solid #47748b;
        color: #fff;
    }

    .api-key-modal .form-control:focus {
        background-color: #2c3136;
        color: #fff;
        border-color: #007bff;
    }

    .filter-settings {
        background-color: #f8f9fa;
        padding: 20px;
        border-radius: 5px;
        margin-bottom: 20px;
    }

    .filter-settings textarea {
        width: 100%;
        min-height: 200px;
        resize: vertical;
    }

    #content .view-container {
        display: none;
    }

    #content .view-container.active {
        display: block;
    }

    .btn-disabled {
        background-color: #6c757d;
        border-color: #6c757d;
        cursor: not-allowed;
        opacity: 0.65;
    }

    .btn-disabled:hover {
        background-color: #6c757d;
        border-color: #6c757d;
    }

    .detail-column {
        width: 100px;
        text-align: center;
    }
    
    .btn-outline-info {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
    }
    
    .job-details th {
        background-color: #f8f9fa;
    }
    
    .modal-description {
        white-space: pre-wrap;
    }

    .progress-wrapper {
        position: relative;
        width: 100%;
    }
    
    .progress-percentage {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: #1a237e;
        font-weight: bold;
        text-shadow: 0 0 3px rgba(255, 255, 255, 0.8);
        font-size: 1.2rem;
        z-index: 1;
        background: rgba(255, 255, 255, 0.7);
        padding: 0 8px;
        border-radius: 3px;
    }

    /* トースト通知のスタイル */
    .toast-notification {
        position: fixed;
        bottom: 20px;
        right: 20px;
        padding: 15px 25px;
        background: #333;
        color: white;
        border-radius: 5px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        z-index: 9999;
        opacity: 0;
        transition: opacity 0.3s ease-in-out;
    }

    .toast-notification.success {
        background: #28a745;
    }

    .toast-notification.error {
        background: #dc3545;
    }

    .toast-notification.warning {
        background: #ffc107;
        color: #333;
    }

    .toast-notification.show {
        opacity: 1;
    }

    /* フィルター設定トースト用スタイル */
    .filter-settings-toast {
        max-width: 700px;
        width: 90%;
        max-height: 300px; /* トーストの高さを制限 */
        overflow-y: auto; /* 内容が多い場合はスクロール可能に */
        background: rgba(255, 255, 255, 0.98);
        color: #333;
        padding: 15px 20px;
        box-shadow: 0 6px 16px rgba(0,0,0,0.2);
        display: none;
        position: fixed;
        left: 270px; /* サイドバーの幅(250px) + 最小余白 */
        top: 650px; /* フィルター設定ボタンにより近い位置 */
        z-index: 9999;
        border-radius: 8px;
        backdrop-filter: blur(5px);
    }

    .filter-settings-toast.show {
        display: block;
        opacity: 1;
    }

    .filter-settings-toast .filter-settings {
        background: none;
        padding: 0;
        margin: 0;
    }

    .filter-settings-toast textarea {
        min-height: 125px;
        font-size: 1.5rem;
        line-height: 1.6;
    }

    .filter-settings-toast h5 {
        font-size: 2.0rem;
        font-weight: bold;
        margin-bottom: 0.8rem;
    }

    .filter-settings-toast .form-group {
        margin-bottom: 1rem;
    }

    .filter-settings-toast label {
        font-weight: bold;
        margin-bottom: 0.5rem;
        font-size: 1.6rem;
    }

    .filter-settings-toast .text-muted {
        margin-bottom: 0.8rem;
        font-size: 1.4rem;
    }
    
    .progress-container progress {
        width: 100%;
        height: 32px;
        border-radius: 4px;
    }
    
    .progress-container progress::-webkit-progress-bar {
        background-color: #f5f5f5;
        border-radius: 4px;
    }
    
    .progress-container progress::-webkit-progress-value {
        background-color: #007bff;
        border-radius: 4px;
        transition: width 0.3s ease;
    }
    
    .progress-container progress::-moz-progress-bar {
        background-color: #007bff;
        border-radius: 4px;
        transition: width 0.3s ease;
    }
</style>
{% endblock %}

{% block content %}
<div class="wrapper">
    <!-- Sidebar -->
    <nav id="sidebar">
        <div class="sidebar-header">
            <h3>案件naviCHO <small style="font-size: 0.6em;">v0.4.3</small></h3>
        </div>

        <!-- ユーザーアバター -->
        <div class="user-info">
            <div class="user-avatar-container" id="user-avatar-container">
                <img src="{{ current_user.avatar_url }}" alt="User avatar" class="user-avatar">
                <div class="logout-toast" id="logout-toast">ログアウト</div>
                <form id="logout-form" action="{{ url_for('logout') }}" method="POST" style="display: none;">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                </form>
            </div>
        </div>
        
        <button class="btn btn-primary btn-fetch">新規情報の取得</button>
        
        <!-- プログレスバーを追加（最初から領域を確保） -->
        <div class="progress-container" style="padding: 10px 20px; visibility: hidden;" aria-busy="true" aria-describedby="progress-status">
            <div class="progress-wrapper" style="position: relative;">
                <progress id="progress-bar" class="progress" value="0" max="100" aria-label="データ取得中..."></progress>
                <span id="progress-percentage" class="progress-percentage">0/0</span>
            </div>
            <small id="progress-status" class="progress-status text-light" style="display: block; text-align: center; margin-top: 5px;">処理中...</small>
        </div>

        <ul class="list-unstyled components">
            <li>
                <a href="#" class="service-link active" data-service="crowdworks">クラウドワークス ▶︎</a>
            </li>
            <li>
                <a href="#" class="service-link disabled" data-service="coconala" style="color: #6c757d; cursor: not-allowed; opacity: 0.65;">ココナラ ▶︎</a>
            </li>
        </ul>
        
        <div class="sidebar-header">
            <h3>設定</h3>
        </div>
        
        <div class="form-group">
            <div class="model-label-container">
                <label for="model-select">使用モデル</label>
                <button type="button" class="api-key-btn" data-toggle="modal" data-target="#apiKeyModal">
                    API Key
                </button>
            </div>
            <select id="model-select" class="form-control">
                <option value="gpt-4o" {% if settings.model == 'gpt-4o' %}selected{% endif %}>GPT-4o</option>
                <option value="gpt-4o-mini" {% if settings.model == 'gpt-4o-mini' %}selected{% endif %}>GPT-4o-mini</option>
                <option value="o1-mini" {% if settings.model == 'o1-mini' %}selected{% endif %}>o1-mini</option>
                <option value="deepseek-chat" {% if settings.model == 'deepseek-chat' %}selected{% endif %}>Deepseek Chat</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="max-items">MAX件数</label>
            <input type="number" class="form-control" id="max-items" min="1" max="100" value="{{ settings.max_items }}">
        </div>
        
        <ul class="list-unstyled components">
            <li>
                <a href="#" class="filter-settings-link">＞ フィルター設定</a>
            </li>
            <li>
                <a href="{{ url_for('job_history_page') }}">
                    <i class="fa fa-history"></i> ＞ 案件履歴
                </a>
            </li>
            <li>
                <a href="#" id="clear-all-data-link" class="text-danger">
                    <i class="fa fa-trash"></i> ＞ 全データクリア
                </a>
            </li>
        </ul>
        
        <!-- 更新確認リンクをサイドバー最下部に配置 -->
        <div style="padding: 15px 20px; text-align: center; margin-top: 20px;">
            <a href="#" id="check-update-link" style="color: #ffffff; font-size: 1.3rem; display: inline-block;">
                <i class="fa fa-refresh"></i> アプリの更新確認
            </a>
        </div>
    </nav>

    <!-- Page Content -->
    <div id="content">
        <div class="container-fluid">
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                            {{ message }}
                            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}

            <!-- ジョブ一覧ビュー -->
            <div class="view-container active" id="jobs-view">
                <h2 class="mb-4">クラウドワークス案件一覧</h2>
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="thead-dark">
                            <tr>
                                <th class="check-column">応募</th>
                                <th class="title-column">タイトル</th>
                                <th class="detail-column">詳細</th>
                                <th class="budget-column">予算</th>
                                <th class="client-column">クライアント</th>
                                <th class="date-column">投稿日</th>
                                <th class="reason-column">選定理由</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for job in jobs %}
                            <tr>
                                <td class="check-column">
                                    <div class="form-check">
                                        <input type="checkbox" 
                                               class="form-check-input job-check" 
                                               data-url="{{ job.url }}"
                                               {% if job.url in checks and checks[job.url].checked %}checked{% endif %}>
                                    </div>
                                </td>
                                <td class="title-column">
                                    <a href="{{ job.url }}" target="_blank">{{ job.title }}</a>
                                </td>
                                <td class="detail-column">
                                    <button class="btn btn-sm btn-info" 
                                            data-toggle="modal" 
                                            data-target="#detailsModal"
                                            data-title="{{ job.title }}"
                                            data-budget="{{ job.budget }}"
                                            data-client="{{ job.client }}"
                                            data-posted-date="{{ job.posted_date }}"
                                            data-description="{{ job.detail_description }}">
                                        詳細を表示
                                    </button>
                                </td>
                                <td class="budget-column">{{ job.budget }}</td>
                                <td class="client-column">{{ job.client }}</td>
                                <td class="date-column">{{ job.posted_date }}</td>
                                <td class="reason-column">{{ job.gpt_reason if job.gpt_reason else '' }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    <!-- 一括応募ボタンを追加 -->
                    <div class="bulk-apply-container text-center mt-4 mb-4">
                        <button id="bulk-apply-btn" class="btn btn-primary btn-lg">
                            一括応募
                        </button>
                        <!-- 進捗表示用のプログレスバー（初期状態は非表示） -->
                        <div class="progress-container mt-3" style="display: none;">
                            <div class="progress">
                                <div class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                            </div>
                            <div class="progress-status text-center mt-2">処理待機中...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- フィルター設定トースト -->
            <div class="toast-notification filter-settings-toast" style="display: none;">
                <div class="filter-settings">
                    <h5>フィルター設定</h5>
                    <div class="form-group mt-3">
                        <p class="text-muted small">案件をフィルタリングするための条件を入力してください。</p>
                        <textarea class="form-control" id="filter-prompt"
                                placeholder="例: 予算が10,000円以上で、Pythonに関連する案件のみ選択">{{ settings.filter_prompt }}</textarea>
                    </div>
                    <div class="d-flex justify-content-end mt-4">
                        <button class="btn btn-secondary mr-4" id="close-filter" style="min-width: 150px; font-size: 1.3rem; padding: 10px 20px;">閉じる</button>
                        <button class="btn btn-primary" id="save-filter" style="min-width: 150px; font-size: 1.3rem; padding: 10px 20px;">保存</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="detailsModal" tabindex="-1" role="dialog" aria-labelledby="detailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="detailsModalLabel"></h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="job-details">
                    <table class="table table-bordered">
                        <tr>
                            <th style="width: 120px;">予算</th>
                            <td class="modal-budget"></td>
                        </tr>
                        <tr>
                            <th>クライアント</th>
                            <td class="modal-client"></td>
                        </tr>
                        <tr>
                            <th>投稿日</th>
                            <td class="modal-posted-date"></td>
                        </tr>
                        <tr>
                            <th>詳細説明</th>
                            <td class="modal-description"></td>
                        </tr>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">閉じる</button>
            </div>
        </div>
    </div>
</div>

<!-- API Key Modal -->
<div class="modal fade" id="apiKeyModal" tabindex="-1" role="dialog" aria-labelledby="apiKeyModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="apiKeyModalLabel">API設定</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="api-key-input">OpenAI API Key</label>
                    <input type="password" class="form-control" id="api-key-input" placeholder="OpenAIのAPIキーを入力してください" value="{{ settings.api_key if settings.api_key else '' }}">
                </div>
                <div class="form-group">
                    <label for="deepseek-api-key-input">Deepseek API Key</label>
                    <input type="password" class="form-control" id="deepseek-api-key-input" placeholder="DeepseekのAPIキーを入力してください" value="{{ settings.deepseek_api_key if settings.deepseek_api_key else '' }}">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">キャンセル</button>
                <button type="button" class="btn btn-primary" id="save-api-key">保存</button>
            </div>
        </div>
    </div>
</div>

<!-- Service Auth Modal -->
<div class="modal fade api-key-modal" id="serviceAuthModal" tabindex="-1" role="dialog" aria-labelledby="serviceAuthModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="serviceAuthModalLabel">認証設定</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="service-email">メールアドレス</label>
                    <input type="email" class="form-control" id="service-email" placeholder="メールアドレスを入力">
                </div>
                <div class="form-group">
                    <label for="service-password">パスワード</label>
                    <input type="password" class="form-control" id="service-password" placeholder="パスワードを入力">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">キャンセル</button>
                <button type="button" class="btn btn-primary" id="save-service-auth">保存</button>
            </div>
        </div>
    </div>
</div>

<!-- 全データクリア確認モーダル -->
<div class="modal fade" id="clearAllDataModal" tabindex="-1" role="dialog" aria-labelledby="clearAllDataModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="clearAllDataModalLabel">データクリアの確認</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p><strong>全ての案件データをクリアします。</strong></p>
                <p class="text-danger">この操作は元に戻せません。よろしいですか？</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">キャンセル</button>
                <button type="button" class="btn btn-danger" id="confirm-clear-all-data">クリア実行</button>
            </div>
        </div>
    </div>
</div>

<!-- アップデートモーダル -->
<div class="modal fade" id="updateModal" tabindex="-1" role="dialog" aria-labelledby="updateModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="updateModalLabel">アプリケーションの更新</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close" id="update-modal-close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div id="update-status-container">
                    <p id="update-status-message">更新を確認中...</p>
                    <div class="progress" id="update-progress-container" style="display: none;">
                        <div id="update-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal" id="update-cancel-btn">キャンセル</button>
                <button type="button" class="btn btn-primary" id="update-start-btn" style="display: none;">更新を開始</button>
                <button type="button" class="btn btn-success" id="update-restart-btn" style="display: none;">再起動</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{super()}}
<script>
// CSRFトークンを取得
const csrfToken = "{{ csrf_token() }}";

// Ajaxリクエスト用のヘッダーを設定
$.ajaxSetup({
    beforeSend: function(xhr, settings) {
        if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type) && !this.crossDomain) {
            xhr.setRequestHeader("X-CSRFToken", csrfToken);
        }
    }
});

document.addEventListener('DOMContentLoaded', function() {
    // アバターとトーストの要素を取得
    const avatarContainer = document.getElementById('user-avatar-container');
    const logoutToast = document.getElementById('logout-toast');
    const logoutForm = document.getElementById('logout-form');
    let toastTimeout;

    // モデル選択の初期化
    const modelSelect = document.getElementById('model-select');
    if (modelSelect) {
        // サーバーから渡されたモデル設定を取得（Jinja2テンプレート変数）
        const savedModel = '{{ settings.model }}';
        if (savedModel) {
            // 対応するオプションを選択
            for (let i = 0; i < modelSelect.options.length; i++) {
                if (modelSelect.options[i].value === savedModel) {
                    modelSelect.selectedIndex = i;
                    break;
                }
            }
        }
    }

    // アバタークリックでトースト表示
    avatarContainer.addEventListener('click', function(e) {
        logoutToast.style.display = 'block';
        clearTimeout(toastTimeout);
        
        // 3秒後に自動で非表示
        toastTimeout = setTimeout(() => {
            logoutToast.style.display = 'none';
        }, 3000);
    });

    // トーストクリックでログアウト
    logoutToast.addEventListener('click', function(e) {
        e.stopPropagation(); // アバターのクリックイベントを停止
        logoutForm.submit();
    });

    // 他の場所をクリックしたらトーストを非表示
    document.addEventListener('click', function(e) {
        if (!avatarContainer.contains(e.target)) {
            logoutToast.style.display = 'none';
        }
    });

    const checkboxes = document.querySelectorAll('.job-check');
    const detailsModal = document.getElementById('detailsModal');
    const bulkApplyBtn = document.getElementById('bulk-apply-btn');
    
    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const url = this.dataset.url;
            const checked = this.checked;
            
            fetch('/update_check', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    url: url,
                    checked: checked
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status !== 'success') {
                    console.error('チェック状態の更新に失敗しました');
                    this.checked = !checked;  // 失敗した場合は元の状態に戻す
                }
            })
            .catch(error => {
                console.error('エラー:', error);
                this.checked = !checked;  // エラーの場合は元の状態に戻す
            });
        });
    });

    // モーダルの設定
    $('#detailsModal').on('show.bs.modal', function (event) {
        const button = $(event.relatedTarget);
        const title = button.data('title');
        const budget = button.data('budget');
        const client = button.data('client');
        const postedDate = button.data('posted-date');
        const description = button.data('description');
        
        const modal = $(this);
        modal.find('.modal-title').text(title);
        modal.find('.modal-budget').text(budget);
        modal.find('.modal-client').text(client);
        modal.find('.modal-posted-date').text(postedDate);
        modal.find('.modal-description').html(description);
    });

    // 一括応募ボタンのイベントリスナー
    bulkApplyBtn.addEventListener('click', async function() {
        // チェックされた案件を取得
        const checkedJobs = Array.from(document.querySelectorAll('.job-check:checked')).map(checkbox => {
            return checkbox.dataset.url;
        });

        if (checkedJobs.length === 0) {
            showAlert('warning', '応募する案件を選択してください。');
            return;
        }

        if (!confirm(`選択された${checkedJobs.length}件の案件に一括応募します。よろしいですか？`)) {
            return;
        }

        const button = this;
        const progressContainer = document.querySelector('.bulk-apply-container .progress-container');
        const progressBar = progressContainer.querySelector('.progress-bar');
        const progressStatus = progressContainer.querySelector('.progress-status');

        try {
            button.disabled = true;
            progressContainer.style.display = 'block';

            const response = await fetch('/bulk_apply', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    urls: checkedJobs
                })
            });

            if (!response.ok) {
                throw new Error('応募処理に失敗しました');
            }

            // Server-Sent Eventsを使用して進捗を監視
            const eventSource = new EventSource('/bulk_apply_progress');
            
            eventSource.onmessage = function(event) {
                const data = JSON.parse(event.data);
                const progress = (data.current / data.total) * 100;
                
                progressBar.style.width = `${progress}%`;
                progressBar.setAttribute('aria-valuenow', progress);
                progressBar.textContent = `${Math.round(progress)}%`;
                
                // 進捗状況の表示を改善
                if (data.status.includes('\n')) {
                    // 最終サマリーの場合
                    progressStatus.innerHTML = data.status.replace(/\n/g, '<br>');
                } else {
                    progressStatus.textContent = data.status;
                }

                if (data.completed) {
                    eventSource.close();
                    button.disabled = false;
                    
                    // 詳細な結果をモーダルで表示
                    let resultMessage = data.status;
                    if (data.details) {
                        resultMessage += '<br><br>処理詳細:<br>' +
                            data.details.map(msg => msg.replace(/</g, '&lt;').replace(/>/g, '&gt;')).join('<br>');
                    }
                    
                    setTimeout(() => {
                        progressContainer.style.display = 'none';
                        showAlert('info', `
                            <div class="result-summary">
                                ${resultMessage}
                            </div>
                            <div class="mt-3">
                                各タブで内容を確認し、送信してください。
                            </div>
                        `);
                    }, 1000);
                }
            };

            eventSource.onerror = function() {
                eventSource.close();
                throw new Error('進捗の監視に失敗しました');
            };

        } catch (error) {
            console.error('Error:', error);
            button.disabled = false;
            progressContainer.style.display = 'none';
            showAlert('danger', error.message);
        }
    });

    // 新規情報取得ボタンのイベントリスナー
    document.querySelector('.btn-fetch').addEventListener('click', async function() {
        try {
            const button = this;
            const progressContainer = document.querySelector('.progress-container');
            const progressBar = document.querySelector('#progress-bar');
            const progressStatus = document.querySelector('#progress-status');
            const progressPercentage = document.querySelector('#progress-percentage');
            const maxItems = parseInt(document.getElementById('max-items').value) || 50;
            
            button.disabled = true;
            button.textContent = '取得中...';
            progressContainer.style.visibility = 'visible';  // display: none から visibility: hidden に変更
            
            // プログレス更新の開始
            let progress = 0;
            const progressInterval = setInterval(() => {
                if (progress < 90) {  // 90%まで徐々に進める
                    progress += Math.random() * 15;
                    const currentProgress = Math.min(progress, 90);
                    // 2つの処理（クローリングとLLM）を1タスクとしてカウント
                    const processedItems = Math.floor((currentProgress / 100) * maxItems);
                    progressBar.value = currentProgress;
                    progressPercentage.textContent = `${processedItems}/${maxItems}`;
                }
            }, 1000);
            
            // 進捗状況の取得を開始
            const statusCheckInterval = setInterval(async () => {
                try {
                    const statusResponse = await fetch('/fetch_status');
                    const statusData = await statusResponse.json();
                    if (statusData.status === 'running') {
                        const message = statusData.message || '処理中...';
                        progressStatus.textContent = message;
                        progressBar.setAttribute('aria-label', message);
                        
                        // ログメッセージに基づいて進捗状況を更新
                        if (message.includes('GPTフィルタリング')) {
                            // フィルタリング中は現在のタスクの後半として扱う
                            const currentTaskProgress = Math.floor(progress / 100 * maxItems);
                            const additionalHalf = 0.5; // 現在のタスクの半分まで進める
                            progressPercentage.textContent = `${currentTaskProgress + additionalHalf}/${maxItems}`;
                        }
                    }
                } catch (error) {
                    console.error('Status check error:', error);
                }
            }, 1000);
            
            const response = await fetch('/fetch_new_data', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token() }}'
                },
                body: JSON.stringify({}) // 空のJSONオブジェクトを送信
            });
            
            const data = await response.json();
            
            // インターバルをクリア
            clearInterval(progressInterval);
            clearInterval(statusCheckInterval);
            
            if (data.status === 'success') {
                // 完了時は100%にする
                progressBar.value = 100;
                progressPercentage.textContent = `${maxItems}/${maxItems}`;
                const completeMessage = '完了！';
                progressStatus.textContent = completeMessage;
                progressBar.setAttribute('aria-label', completeMessage);
                setTimeout(() => {
                    progressContainer.style.visibility = 'hidden';  // display: none から visibility: hidden に変更
                    // 完了メッセージを表示
                    alert('新規データの取得が完了しました');
                    // 画面をリフレッシュ
                    window.location.reload();
                }, 500);
            } else {
                throw new Error(data.message);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('エラーが発生しました: ' + error.message);
        } finally {
            const button = document.querySelector('.btn-fetch');
            button.disabled = false;
            button.textContent = '新規情報の取得';
        }
    });

    // テーブルの内容を更新する関数
    function updateJobsTable(jobs) {
        const tbody = document.querySelector('table tbody');
        tbody.innerHTML = '';
        
        jobs.forEach(job => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="check-column">
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input job-check" data-url="${job.url}" 
                            ${checks[job.url]?.checked ? 'checked' : ''}>
                    </div>
                </td>
                <td class="title-column">
                    <a href="${job.url}" target="_blank">${job.title}</a>
                </td>
                <td class="detail-column">
                    <button class="btn btn-sm btn-info" 
                            data-toggle="modal" 
                            data-target="#detailsModal"
                            data-title="${job.title}"
                            data-budget="${job.budget}"
                            data-client="${job.client}"
                            data-posted-date="${new Date(job.posted_date).toLocaleDateString()}"
                            data-description="${job.detail_description || '詳細情報なし'}">
                        詳細を表示
                    </button>
                </td>
                <td class="budget-column">${job.budget}</td>
                <td class="client-column">${job.client}</td>
                <td class="date-column">${new Date(job.posted_date).toLocaleDateString()}</td>
                <td class="reason-column">${job.gpt_reason || ''}</td>
            `;
            tbody.appendChild(tr);
        });
    }

    // 設定の変更を監視
    document.getElementById('model-select').addEventListener('change', function() {
        const selectedModel = this.value;
        updateSettings({ model: selectedModel });
    });

    document.getElementById('max-items').addEventListener('change', function() {
        const maxItems = parseInt(this.value);
        if (maxItems >= 1 && maxItems <= 100) {
            updateSettings({ max_items: maxItems });
        }
    });

    // API Key保存処理
    document.getElementById('save-api-key').addEventListener('click', function() {
        const apiKey = document.getElementById('api-key-input').value;
        const deepseekApiKey = document.getElementById('deepseek-api-key-input').value;
        const model = document.getElementById('model-select').value;
        
        updateSettings({
            api_key: apiKey,
            deepseek_api_key: deepseekApiKey,
            model: model
        });
        
        $('#apiKeyModal').modal('hide');
    });

    // フィルター設定リンクのクリックイベント
    document.querySelector('.filter-settings-link').addEventListener('click', function(e) {
        e.preventDefault();
        
        // トースト表示
        let filterToast = document.querySelector('.filter-settings-toast');
        
        // トースト要素が存在しない場合は再作成
        if (!filterToast) {
            console.log('フィルター設定トースト要素を再作成します');
            
            // コンテナ要素を取得
            const container = document.querySelector('#content .container-fluid');
            if (container) {
                // 新しいトースト要素を作成
                filterToast = document.createElement('div');
                filterToast.className = 'toast-notification filter-settings-toast';
                filterToast.style.display = 'none';
                
                // 内部要素を作成
                filterToast.innerHTML = `
                    <div class="filter-settings">
                        <h5>フィルター設定</h5>
                        <div class="form-group mt-3">
                            <p class="text-muted small">案件をフィルタリングするための条件を入力してください。</p>
                            <textarea class="form-control" id="filter-prompt"
                                    placeholder="例: 予算が10,000円以上で、Pythonに関連する案件のみ選択">${originalFilterPrompt || ''}</textarea>
                        </div>
                        <div class="d-flex justify-content-end mt-4">
                            <button class="btn btn-secondary mr-4" id="close-filter" style="min-width: 150px; font-size: 1.3rem; padding: 10px 20px;">閉じる</button>
                            <button class="btn btn-primary" id="save-filter" style="min-width: 150px; font-size: 1.3rem; padding: 10px 20px;">保存</button>
                        </div>
                    </div>
                `;
                
                // コンテナに追加
                container.appendChild(filterToast);
                
                // イベントリスナーを再設定
                document.getElementById('close-filter').addEventListener('click', closeFilterToast);
                document.getElementById('save-filter').addEventListener('click', saveFilterSettings);
                
                // フィルター設定の入力変更を監視
                setupFilterPromptListener();
            }
        }
        
        if (filterToast) {
            // 既存のトーストを表示
            filterToast.style.display = 'block';
            setTimeout(() => {
                filterToast.classList.add('show');
            }, 10);
            
            // フィルター設定の初期状態を設定
            const filterPrompt = document.getElementById('filter-prompt');
            if (filterPrompt) {
                originalFilterPrompt = filterPrompt.value;
            }
        } else {
            console.error('フィルター設定トースト要素が見つかりません');
            showToast('フィルター設定を表示できません', 'error');
        }
    });

    // フィルター設定を閉じる関数
    function closeFilterToast() {
        const filterToast = document.querySelector('.filter-settings-toast');
        if (filterToast) {
            filterToast.classList.remove('show');
            setTimeout(() => {
                filterToast.style.display = 'none';
            }, 300);
        } else {
            console.error('フィルター設定トースト要素が見つかりません');
        }
    }

    // フィルター設定を保存する関数
    function saveFilterSettings() {
        const filterPrompt = document.getElementById('filter-prompt');
        if (filterPrompt) {
            updateSettings({ filter_prompt: filterPrompt.value });
            
            // 保存後にトーストを閉じる
            const filterToast = document.querySelector('.filter-settings-toast');
            if (filterToast) {
                filterToast.classList.remove('show');
                setTimeout(() => {
                    filterToast.style.display = 'none';
                    // 完了通知を表示
                    showToast('フィルター設定を保存しました', 'success');
                }, 300);
                
                // 値を保存
                originalFilterPrompt = filterPrompt.value;
            } else {
                console.error('フィルター設定トースト要素が見つかりません');
                showToast('フィルター設定を保存しました', 'success');
            }
        } else {
            console.error('フィルター設定入力要素が見つかりません');
            showToast('フィルター設定の保存に失敗しました', 'error');
        }
    }

    // フィルター設定を閉じるボタンのイベントリスナー
    document.getElementById('close-filter')?.addEventListener('click', closeFilterToast);

    // フィルター設定を保存するボタンのイベントリスナー
    document.getElementById('save-filter')?.addEventListener('click', saveFilterSettings);

    // サービスリンクのクリック処理
    const serviceLinks = document.querySelectorAll('.service-link');
    let currentService = '';
    
    serviceLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const service = this.dataset.service;
            currentService = service;
            
            // アクティブなリンクを更新
            serviceLinks.forEach(l => l.classList.remove('active'));
            this.classList.add('active');
            
            // 認証情報をチェック
            fetch('/check_auth', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token() }}'
                },
                body: JSON.stringify({ service: service })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('認証情報の確認に失敗しました');
                }
                return response.json();
            })
            .then(data => {
                if (!data.authenticated) {
                    // 認証情報がない場合はモーダルを表示
                    const modal = $('#serviceAuthModal');
                    modal.find('.modal-title').text(`${service === 'crowdworks' ? 'CrowdWorks' : 'ココナラ'}の認証設定`);
                    modal.find('#service-email').val('');
                    modal.find('#service-password').val('');
                    modal.modal('show');
                }
                
                // ビューをジョブ一覧に切り替え
                const views = document.querySelectorAll('.view-container');
                views.forEach(view => view.classList.remove('active'));
                document.getElementById('jobs-view').classList.add('active');
            })
            .catch(error => {
                console.error('エラー:', error);
                showAlert('danger', `サービス情報の取得に失敗しました: ${error.message}`);
            });
        });
    });

    // サービス認証情報の保存
    document.getElementById('save-service-auth').addEventListener('click', function() {
        const email = document.getElementById('service-email').value;
        const password = document.getElementById('service-password').value;
        
        const settings = {
            [`${currentService}_email`]: email,
            [`${currentService}_password`]: password
        };
        
        updateSettings(settings);
        $('#serviceAuthModal').modal('hide');
        
        // ビューを切り替え
        const views = document.querySelectorAll('.view-container');
        views.forEach(view => view.classList.remove('active'));
        document.getElementById('jobs-view').classList.add('active');
    });

    // フィルター設定の変更監視
    let originalFilterPrompt = document.getElementById('filter-prompt') ? document.getElementById('filter-prompt').value : '';
    
    // フィルター設定の入力変更を監視する関数
    function setupFilterPromptListener() {
        const filterPrompt = document.getElementById('filter-prompt');
        if (filterPrompt) {
            filterPrompt.addEventListener('input', function() {
                const currentValue = this.value;
                const saveFilterBtn = document.getElementById('save-filter');
                if (saveFilterBtn) {
                    const hasChanged = currentValue !== originalFilterPrompt;
                    
                    if (hasChanged) {
                        saveFilterBtn.classList.add('btn-primary');
                        saveFilterBtn.classList.remove('btn-secondary');
                    } else {
                        saveFilterBtn.classList.remove('btn-primary');
                        saveFilterBtn.classList.add('btn-secondary');
                    }
                }
            });
        }
    }
    
    // 初期設定
    setupFilterPromptListener();

    // 設定を更新する関数
    function updateSettings(settings) {
        fetch('/update_settings', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token() }}'
            },
            body: JSON.stringify(settings)
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                showAlert('success', '設定を更新しました');
            } else {
                showAlert('danger', 'エラー: ' + data.message);
            }
        })
        .catch(error => {
            showAlert('danger', 'エラー: ' + error.message);
        });
    }

    // アラート表示関数
    function showAlert(type, message) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        alertDiv.role = 'alert';
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        `;
        
        // コンテナ要素の存在確認を追加
        const container = document.querySelector('.container');
        if (container) {
            container.insertBefore(alertDiv, container.firstChild);
            
            // 3秒後に自動で消える
            setTimeout(() => {
                alertDiv.remove();
            }, 3000);
        } else {
            // コンテナが見つからない場合はbodyに追加
            document.body.appendChild(alertDiv);
            
            // 3秒後に自動で消える
            setTimeout(() => {
                alertDiv.remove();
            }, 3000);
        }
    }
    
    // トースト通知表示関数
    function showToast(message, type = 'success') {
        // 既存のトーストを削除
        const existingToast = document.querySelector('.toast-notification');
        if (existingToast) {
            existingToast.remove();
        }

        // 新しいトーストを作成
        const toast = document.createElement('div');
        toast.className = `toast-notification ${type}`;
        toast.textContent = message;

        // bodyに追加
        document.body.appendChild(toast);

        // アニメーションのためにshowクラスを追加
        setTimeout(() => {
            toast.classList.add('show');
        }, 10);

        // 3秒後に消える
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => {
                toast.remove();
            }, 300);
        }, 3000);
    }

    // 全データクリアリンクのクリックイベント
    $('#clear-all-data-link').click(function(e) {
        e.preventDefault();
        $('#clearAllDataModal').modal('show');
    });
    
    // 全データクリア確認ボタンのクリックイベント
    $('#confirm-clear-all-data').click(function() {
        // 全データクリア
        $.ajax({
            url: '/api/job_history/clear',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({}),
            success: function(response) {
                if (response.success) {
                    // モーダルを閉じる
                    $('#clearAllDataModal').modal('hide');
                    
                    // 成功メッセージを表示
                    alert(response.message);
                    
                    // ページをリロード
                    location.reload();
                } else {
                    alert('エラー: ' + response.message);
                }
            },
            error: function(xhr, status, error) {
                let errorMsg = 'データのクリアに失敗しました。';
                try {
                    const response = JSON.parse(xhr.responseText);
                    if (response.message) {
                        errorMsg = response.message;
                    }
                } catch (e) {}
                
                alert('エラー: ' + errorMsg);
            }
        });
    });

    // アップデート機能
    $(document).ready(function() {
        // 更新確認ボタンのクリックイベント
        $('#check-update-link').on('click', function(e) {
            e.preventDefault();
            
            // モーダルを表示
            $('#updateModal').modal('show');
            
            // 初期状態をリセット
            $('#update-status-message').text('更新を確認中...');
            $('#update-progress-container').hide();
            $('#update-progress-bar').css('width', '0%').attr('aria-valuenow', 0);
            $('#update-start-btn').hide();
            $('#update-restart-btn').hide();
            $('#update-cancel-btn').show();
            $('#update-modal-close').show();
            
            // 更新を確認
            checkForUpdates();
        });
        
        // 更新開始ボタンのクリックイベント
        $('#update-start-btn').on('click', function() {
            // 更新を開始
            performUpdate();
            
            // ボタンの状態を更新
            $(this).hide();
            $('#update-cancel-btn').hide();
            $('#update-modal-close').hide();
        });
        
        // 再起動ボタンのクリックイベント
        $('#update-restart-btn').on('click', function() {
            // ページをリロード
            location.reload();
        });
        
        // 更新の確認
        function checkForUpdates() {
            $.ajax({
                url: '/api/check_updates',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({}),
                headers: {
                    'X-CSRFToken': csrfToken
                },
                success: function(response) {
                    if (response.update_available) {
                        // 更新が利用可能
                        $('#update-status-message').html(
                            `新しいバージョン <strong>${response.latest_version}</strong> が利用可能です。<br>` +
                            `現在のバージョン: ${response.current_version}`
                        );
                        $('#update-start-btn').show();
                    } else {
                        // 最新バージョンを使用中
                        $('#update-status-message').html(
                            `お使いのバージョン <strong>${response.current_version}</strong> は最新です。`
                        );
                    }
                },
                error: function(xhr, status, error) {
                    // エラー処理
                    let errorMessage = '更新の確認中にエラーが発生しました。';
                    try {
                        const response = JSON.parse(xhr.responseText);
                        if (response.message) {
                            errorMessage = response.message;
                        }
                    } catch (e) {}
                    
                    $('#update-status-message').html(
                        `<span class="text-danger">${errorMessage}</span>`
                    );
                }
            });
        }
        
        // 更新の実行
        function performUpdate() {
            // プログレスバーを表示
            $('#update-progress-container').show();
            
            $.ajax({
                url: '/api/perform_update',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({}),
                headers: {
                    'X-CSRFToken': csrfToken
                },
                success: function(response) {
                    if (response.success) {
                        // 更新成功
                        $('#update-status-message').html(
                            `<span class="text-success">${response.message}</span>`
                        );
                        $('#update-restart-btn').show();
                    } else {
                        // 更新失敗
                        $('#update-status-message').html(
                            `<span class="text-danger">${response.message}</span>`
                        );
                        $('#update-cancel-btn').show();
                    }
                },
                error: function(xhr, status, error) {
                    // エラー処理
                    let errorMessage = '更新の実行中にエラーが発生しました。';
                    try {
                        const response = JSON.parse(xhr.responseText);
                        if (response.message) {
                            errorMessage = response.message;
                        }
                    } catch (e) {}
                    
                    $('#update-status-message').html(
                        `<span class="text-danger">${errorMessage}</span>`
                    );
                    $('#update-cancel-btn').show();
                },
                xhr: function() {
                    const xhr = new window.XMLHttpRequest();
                    
                    // 更新の進捗状況を取得
                    const updateProgressInterval = setInterval(function() {
                        $.ajax({
                            url: '/api/update_status',
                            type: 'GET',
                            headers: {
                                'X-CSRFToken': csrfToken
                            },
                            success: function(data) {
                                // プログレスバーを更新
                                $('#update-progress-bar').css('width', data.progress + '%').attr('aria-valuenow', data.progress);
                                
                                // ステータスメッセージを更新
                                $('#update-status-message').text(data.status);
                                
                                // 更新が完了したら進捗状況の取得を停止
                                if (data.progress >= 100) {
                                    clearInterval(updateProgressInterval);
                                }
                            }
                        });
                    }, 1000);
                    
                    return xhr;
                }
            });
        }
    });
});
</script>
{% endblock %} 